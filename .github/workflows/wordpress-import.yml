name: WordPress Import Workflow

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
        - development
      mode:
        description: 'Import mode'
        required: true
        default: 'sync'
        type: choice
        options:
        - sync
        - override
      product_limit:
        description: 'Number of products to import'
        required: false
        default: '50'
        type: string
      use_enhanced_files:
        description: 'Use enhanced files (recommended)'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  import-products:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        pip install requests
        
    - name: Set environment-specific secrets
      id: set-secrets
      run: |
        ENVIRONMENT="${{ github.event.inputs.environment }}"
        echo "Setting secrets for environment: $ENVIRONMENT"
        
        # For testing - use hardcoded values if secrets are not set
        if [ -n "${{ secrets.WP_API_URL }}" ]; then
          echo "WP_API_URL=${{ secrets.WP_API_URL }}" >> $GITHUB_ENV
        else
          echo "WP_API_URL=https://unwritten-bottle.localsite.io/wp-json/promostandards-importer/v1/upload" >> $GITHUB_ENV
        fi
        
        if [ -n "${{ secrets.WP_API_KEY }}" ]; then
          echo "WP_API_KEY=${{ secrets.WP_API_KEY }}" >> $GITHUB_ENV
        else
          echo "WP_API_KEY=test-api-key" >> $GITHUB_ENV
        fi
        
        if [ -n "${{ secrets.WP_BASIC_AUTH_USER }}" ]; then
          echo "WP_BASIC_AUTH_USER=${{ secrets.WP_BASIC_AUTH_USER }}" >> $GITHUB_ENV
        fi
        
        if [ -n "${{ secrets.WP_BASIC_AUTH_PASS }}" ]; then
          echo "WP_BASIC_AUTH_PASS=${{ secrets.WP_BASIC_AUTH_PASS }}" >> $GITHUB_ENV
        fi
        
        echo "‚úÖ Environment secrets set for: $ENVIRONMENT"
        echo "API URL: $WP_API_URL"
        
    - name: Run WordPress Import Script
      id: import-process
      env:
        IMPORT_MODE: ${{ github.event.inputs.mode }}
        PRODUCT_LIMIT: ${{ github.event.inputs.product_limit }}
        USE_ENHANCED_FILES: ${{ github.event.inputs.use_enhanced_files }}
      run: |
        echo "üöÄ Starting WordPress Import"
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Mode: ${{ github.event.inputs.mode }}"
        echo "Product Limit: ${{ github.event.inputs.product_limit }}"
        echo "Use Enhanced Files: ${{ github.event.inputs.use_enhanced_files }}"
        echo "API URL: $WP_API_URL"
        echo ""
        
        # Check if directories exist
        echo "üìÅ Checking directories..."
        ls -la
        if [ -d "enhanced" ]; then
          echo "üìÅ Enhanced directory exists:"
          ls -la enhanced/
        else
          echo "üìÅ Enhanced directory does not exist"
        fi
        
        if [ -d "batch" ]; then
          echo "üìÅ Batch directory exists:"
          ls -la batch/
        else
          echo "üìÅ Batch directory does not exist"
        fi
        
        echo ""
        
        # Create test file if no files exist (for testing)
        if [ "$USE_ENHANCED_FILES" = "true" ] && [ ! -d "enhanced" ]; then
          echo "üìù Creating test enhanced directory and file..."
          mkdir -p enhanced
          echo '{"product": {"ProductID": "TEST001", "Name": "Test Product", "SKU": "TEST-SKU-001", "ShortDescription": "Test product for workflow testing", "ScrapedDate": "2025-01-25T12:00:00Z"}, "pricing": {"base_price": {"Price": 9.99}}, "attributes": {"colors": [{"Name": "Red"}]}}' > enhanced/test_enhanced.jsonl
        fi
        
        if [ "$USE_ENHANCED_FILES" = "false" ] && [ ! -d "batch" ]; then
          echo "üìù Creating test batch directory and file..."
          mkdir -p batch
          echo '{"ProductID": "TEST001", "Name": "Test Product", "SKU": "TEST-SKU-001", "ShortDescription": "Test product for workflow testing", "ScrapedDate": "2025-01-25T12:00:00Z"}' > batch/batch_test.jsonl
        fi
        
        echo ""
        
        # Run the import script with proper authentication
        python import_to_wordpress.py \
          --wp-api-url "$WP_API_URL" \
          --wp-api-key "$WP_API_KEY" \
          --mode "$IMPORT_MODE" \
          --product-limit "$PRODUCT_LIMIT" \
          $([ "$USE_ENHANCED_FILES" = "true" ] && echo "--use-enhanced-files") \
          $([ -n "$WP_BASIC_AUTH_USER" ] && echo "--wp-basic-auth-user" "$WP_BASIC_AUTH_USER") \
          $([ -n "$WP_BASIC_AUTH_PASS" ] && echo "--wp-basic-auth-pass" "$WP_BASIC_AUTH_PASS")
        
    - name: Upload import results
      uses: actions/upload-artifact@v4
      with:
        name: import-results-${{ github.event.inputs.environment }}
        path: |
          import_summary.json
          import_errors.json
          import_progress.json
          import_heartbeat.json
        retention-days: 30
        
    - name: Display results
      run: |
        echo "üéâ Import completed!"
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Mode: ${{ github.event.inputs.mode }}"
        echo "Use Enhanced Files: ${{ github.event.inputs.use_enhanced_files }}"
        echo "Product Limit: ${{ github.event.inputs.product_limit }}"
        echo ""
        
        # Display summary if available
        if [ -f "import_summary.json" ]; then
          echo "üìä Import Summary:"
          cat import_summary.json | python -m json.tool
        fi
        
        # Display heartbeat if available
        if [ -f "import_heartbeat.json" ]; then
          echo ""
          echo "üíì Import Heartbeat:"
          cat import_heartbeat.json | python -m json.tool
        fi
        
        # Display errors if any
        if [ -f "import_errors.json" ]; then
          echo ""
          echo "‚ùå Import Errors:"
          cat import_errors.json | python -m json.tool
        fi
