name: WordPress Import Workflow

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
        - development
      mode:
        description: 'Import mode'
        required: true
        default: 'sync'
        type: choice
        options:
        - sync
        - override
      product_limit:
        description: 'Number of products to import'
        required: false
        default: '50'
        type: string
      use_enhanced_files:
        description: 'Use enhanced files (recommended)'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  import-products:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        pip install requests
        
    - name: Get WordPress endpoints dynamically
      id: get-endpoints
      run: |
        ENVIRONMENT="${{ github.event.inputs.environment }}"
        echo "Getting endpoints for environment: $ENVIRONMENT"
        
        # Define environment URLs using bash
        if [ "$ENVIRONMENT" = "staging" ]; then
          BASE_URL="https://tmgdev.dedicatedmkt.com"
        elif [ "$ENVIRONMENT" = "production" ]; then
          BASE_URL="https://tmg.dedicatedmkt.com"
        else
          BASE_URL="https://unwritten-bottle.localsite.io"
        fi
        
        API_URL="$BASE_URL/wp-json/promostandards-importer/v1/upload"
        WORKFLOW_STATUS_URL="$BASE_URL/wp-json/promostandards-importer/v1/workflow-status"
        API_KEY="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"
        
        echo "‚úÖ Using direct endpoints"
        echo "Base URL: $BASE_URL"
        echo "API URL: $API_URL"
        echo "Workflow Status URL: $WORKFLOW_STATUS_URL"
        echo "API Key: ${API_KEY:0:10}..."
        
        # Set environment variables
        echo "WP_API_URL=$API_URL" >> $GITHUB_ENV
        echo "WP_API_KEY=$API_KEY" >> $GITHUB_ENV
        echo "WORKFLOW_STATUS_URL=$WORKFLOW_STATUS_URL" >> $GITHUB_ENV
        
        # Load Basic Auth credentials from .env.dev file for local development
        if [ "$ENVIRONMENT" = "development" ]; then
          echo "üìÅ Loading Basic Auth credentials from .env.dev file..."
          
          # Source the .env.dev file to get the variables
          if [ -f ".env.dev" ]; then
            # Read the Basic Auth credentials from .env.dev
            WP_BASIC_AUTH_USER=$(grep "^WP_BASIC_AUTH_USER=" .env.dev | cut -d'=' -f2)
            WP_BASIC_AUTH_PASS=$(grep "^WP_BASIC_AUTH_PASS=" .env.dev | cut -d'=' -f2)
            
            echo "WP_BASIC_AUTH_USER=$WP_BASIC_AUTH_USER" >> $GITHUB_ENV
            echo "WP_BASIC_AUTH_PASS=$WP_BASIC_AUTH_PASS" >> $GITHUB_ENV
            echo "‚úÖ Basic Auth credentials loaded from .env.dev file"
            echo "User: ${WP_BASIC_AUTH_USER:0:3}..."
            echo "Pass: ${WP_BASIC_AUTH_PASS:0:3}..."
          else
            echo "‚ö†Ô∏è .env.dev file not found, skipping Basic Auth"
          fi
        fi
        
    - name: Copy artifacts from artifacts branch
      id: copy-artifacts
      run: |
        echo "üìÅ Copying artifacts from artifacts branch..."

        # Fetch the artifacts branch
        git fetch origin artifacts:artifacts
        
        # Copy enhanced files from artifacts branch
        if git show artifacts:enhanced/ > /dev/null 2>&1; then
          echo "üìÅ Copying enhanced files from artifacts branch..."
          git checkout artifacts -- enhanced/
          ls -la enhanced/
        else
          echo "‚ö†Ô∏è No enhanced directory found in artifacts branch"
        fi
        
        # Copy batch files from artifacts branch
        if git show artifacts:batch/ > /dev/null 2>&1; then
          echo "üìÅ Copying batch files from artifacts branch..."
          git checkout artifacts -- batch/
          ls -la batch/
        else
          echo "‚ö†Ô∏è No batch directory found in artifacts branch"
        fi
        
        echo "‚úÖ Artifacts copied successfully"
        
    - name: Notify WordPress - Workflow Started
      run: |
        echo "üì° Notifying WordPress that workflow has started..."
        curl -X POST "$WORKFLOW_STATUS_URL" \
          -H "Content-Type: application/json" \
          -H "X-API-Key: $WP_API_KEY" \
          -d "{
            \"workflow_id\": \"${{ github.run_id }}\",
            \"status\": \"running\",
            \"message\": \"GitHub Actions workflow started\",
            \"details\": {
              \"environment\": \"${{ github.event.inputs.environment }}\",
              \"mode\": \"${{ github.event.inputs.mode }}\",
              \"product_limit\": \"${{ github.event.inputs.product_limit }}\",
              \"use_enhanced_files\": \"${{ github.event.inputs.use_enhanced_files }}\"
            }
          }"
        echo "‚úÖ WordPress notified of workflow start"
        
    - name: Process and import products
      id: import-process
      env:
        IMPORT_MODE: ${{ github.event.inputs.mode }}
        PRODUCT_LIMIT: ${{ github.event.inputs.product_limit }}
        USE_ENHANCED_FILES: ${{ github.event.inputs.use_enhanced_files }}
      continue-on-error: true
      run: |
        echo "üöÄ Starting WordPress Import"
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Mode: ${{ github.event.inputs.mode }}"
        echo "Product Limit: ${{ github.event.inputs.product_limit }}"
        echo "Use Enhanced Files: ${{ github.event.inputs.use_enhanced_files }}"
        echo ""
        
        # Check available files
        echo "üìÅ Available files:"
        ls -la
        if [ -d "enhanced" ]; then
          echo "üìÅ Enhanced files:"
          ls -la enhanced/
        fi
        if [ -d "batch" ]; then
          echo "üìÅ Batch files:"
          ls -la batch/
        fi
        echo ""
        
        # Debug: Show what will be passed to Python script
        echo ""
        echo "üîç Python script parameters:"
        echo "WP_API_URL: ${WP_API_URL:0:20}..."
        echo "WP_API_KEY: ${WP_API_KEY:0:10}..."
        echo "IMPORT_MODE: $IMPORT_MODE"
        echo "PRODUCT_LIMIT: $PRODUCT_LIMIT"
        echo "USE_ENHANCED_FILES: $USE_ENHANCED_FILES"
        echo "WP_BASIC_AUTH_USER: $WP_BASIC_AUTH_USER"
        echo "WP_BASIC_AUTH_PASS: ${WP_BASIC_AUTH_PASS:0:5}..."
        echo ""
        
        # Run the import script
        python import_to_wordpress.py \
          --wp-api-url "$WP_API_URL" \
          --wp-api-key "$WP_API_KEY" \
          --mode "$IMPORT_MODE" \
          --product-limit "$PRODUCT_LIMIT" \
          $([ "$USE_ENHANCED_FILES" = "true" ] && echo "--use-enhanced-files") \
          $([ -n "$WP_BASIC_AUTH_USER" ] && echo "--wp-basic-auth-user" "$WP_BASIC_AUTH_USER") \
          $([ -n "$WP_BASIC_AUTH_PASS" ] && echo "--wp-basic-auth-pass" "$WP_BASIC_AUTH_PASS")
        
    - name: Upload import results
      uses: actions/upload-artifact@v4
      with:
        name: import-results-${{ github.event.inputs.environment }}
        path: |
          import_summary.json
          import_errors.json
          import_progress.json
          import_heartbeat.json
        retention-days: 30
        
    - name: Display results
      run: |
        echo "üéâ Import completed!"
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Mode: ${{ github.event.inputs.mode }}"
        echo "Use Enhanced Files: ${{ github.event.inputs.use_enhanced_files }}"
        echo "Product Limit: ${{ github.event.inputs.product_limit }}"
        echo ""
        
        # Display summary if available
        if [ -f "import_summary.json" ]; then
          echo "üìä Import Summary:"
          cat import_summary.json | python -m json.tool
        fi
        
        # Display heartbeat if available
        if [ -f "import_heartbeat.json" ]; then
          echo ""
          echo "üíì Import Heartbeat:"
          cat import_heartbeat.json | python -m json.tool
        fi
        
        # Display errors if any
        if [ -f "import_errors.json" ]; then
          echo ""
          echo "‚ùå Import Errors:"
          cat import_errors.json | python -m json.tool
        fi
        
        # Notify WordPress that workflow has completed
        echo ""
        echo "üì° Notifying WordPress that workflow has completed..."
        curl -X POST "$WORKFLOW_STATUS_URL" \
          -H "Content-Type: application/json" \
          -H "X-API-Key: $WP_API_KEY" \
          -d "{
            \"workflow_id\": \"${{ github.run_id }}\",
            \"status\": \"completed\",
            \"message\": \"GitHub Actions workflow completed successfully\",
            \"details\": {
              \"environment\": \"${{ github.event.inputs.environment }}\",
              \"mode\": \"${{ github.event.inputs.mode }}\",
              \"product_limit\": \"${{ github.event.inputs.product_limit }}\",
              \"use_enhanced_files\": \"${{ github.event.inputs.use_enhanced_files }}\",
              \"run_id\": \"${{ github.run_id }}\",
              \"run_number\": \"${{ github.run_number }}\"
            }
          }"
        echo "‚úÖ WordPress notified of workflow completion"
